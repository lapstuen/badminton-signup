<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #10b981;
            margin-bottom: 20px;
            font-size: 2em;
        }
        .status {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #666;
        }
        .status.loading {
            border-left-color: #f59e0b;
        }
        .status.success {
            border-left-color: #10b981;
        }
        .status.error {
            border-left-color: #ef4444;
        }
        .status h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.5;
            margin-top: 10px;
        }
        .button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        .button:hover {
            background: #059669;
        }
        .button.secondary {
            background: #3b82f6;
        }
        .button.secondary:hover {
            background: #2563eb;
        }
        .button.danger {
            background: #ef4444;
        }
        .button.danger:hover {
            background: #dc2626;
        }
        .console-log {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .console-log h2 {
            margin-bottom: 15px;
            color: #10b981;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry.log {
            background: #0a0a0a;
            color: #10b981;
        }
        .log-entry.error {
            background: #2d1515;
            color: #fca5a5;
        }
        .log-entry.warn {
            background: #2d2415;
            color: #fde68a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Badminton App Diagnostics</h1>

        <div>
            <button class="button" onclick="window.location.href='index.html'">‚Üê Back to App</button>
            <button class="button secondary" onclick="runDiagnostics()">üîÑ Re-run Diagnostics</button>
            <button class="button danger" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
        </div>

        <div id="results"></div>

        <div class="console-log">
            <h2>üìã Console Log</h2>
            <div id="console"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const results = document.getElementById('results');
        const consoleDiv = document.getElementById('console');

        // Intercept console.log, console.error, console.warn
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv('log', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToDiv('warn', args.join(' '));
        };

        function logToDiv(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function addStatus(title, status, content) {
            const div = document.createElement('div');
            div.className = `status ${status}`;
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            div.innerHTML = `
                <h2>${icon} ${title}</h2>
                <pre>${content}</pre>
            `;
            results.appendChild(div);
        }

        function clearAll() {
            if (confirm('‚ö†Ô∏è This will:\n\n1. Clear all localStorage (log you out)\n2. NOT delete Firestore data\n\nContinue?')) {
                localStorage.clear();
                addStatus('LocalStorage Cleared', 'success', 'All local data cleared.\nRefresh to see changes.');
            }
        }

        let currentSessionId = new Date().toISOString().split('T')[0];
        const currentSessionRef = () => sessionsRef.doc(currentSessionId);
        const playersRef = () => currentSessionRef().collection('players');

        async function runDiagnostics() {
            results.innerHTML = '';

            console.log('üîß Starting diagnostics...');

            // 1. Check Firebase loaded
            addStatus('1. Firebase SDK',
                typeof firebase !== 'undefined' ? 'success' : 'error',
                typeof firebase !== 'undefined'
                    ? 'Firebase SDK loaded successfully'
                    : 'Firebase SDK NOT LOADED - Check internet connection'
            );

            // 2. Check DB connection
            try {
                addStatus('2. Firestore Connection', 'success', `Connected to project: ${db.app.options.projectId}`);
            } catch (error) {
                addStatus('2. Firestore Connection', 'error', error.message);
                return;
            }

            // 3. Check current session
            try {
                const sessionDoc = await currentSessionRef().get();
                if (sessionDoc.exists) {
                    addStatus('3. Current Session', 'success',
                        `Session ID: ${currentSessionId}\n` +
                        `Date: ${sessionDoc.data().date}\n` +
                        `Day: ${sessionDoc.data().day}\n` +
                        `Time: ${sessionDoc.data().time}\n` +
                        `Max Players: ${sessionDoc.data().maxPlayers}\n` +
                        `Payment: ${sessionDoc.data().paymentAmount} THB`
                    );
                } else {
                    addStatus('3. Current Session', 'error',
                        `No session found for ${currentSessionId}\n\n` +
                        `The app should create one automatically.\n` +
                        `Try opening index.html`
                    );
                }
            } catch (error) {
                addStatus('3. Current Session', 'error', `Error: ${error.message}\n\nCode: ${error.code}`);
            }

            // 4. Check players
            try {
                const playersSnap = await playersRef().get();
                addStatus('4. Registered Players',
                    playersSnap.size > 0 ? 'success' : 'loading',
                    `Total players: ${playersSnap.size}\n\n` +
                    (playersSnap.size > 0
                        ? playersSnap.docs.map((doc, i) => {
                            const p = doc.data();
                            return `${i+1}. ${p.name} ${p.paid ? '‚úì' : '‚óã'}`;
                        }).join('\n')
                        : 'No players registered yet')
                );
            } catch (error) {
                addStatus('4. Registered Players', 'error', error.message);
            }

            // 5. Check authorized users
            try {
                const usersSnap = await usersRef.get();
                addStatus('5. Authorized Users',
                    usersSnap.size > 0 ? 'success' : 'error',
                    `Total users: ${usersSnap.size}\n\n` +
                    (usersSnap.size > 0
                        ? usersSnap.docs.map((doc, i) => {
                            const u = doc.data();
                            return `${i+1}. ${u.name} (Balance: ${u.balance || 0} THB)`;
                        }).join('\n')
                        : '‚ö†Ô∏è NO USERS FOUND!\n\nYou need to add users via Admin panel.')
                );
            } catch (error) {
                addStatus('5. Authorized Users', 'error', error.message);
            }

            // 6. Check localStorage
            const loggedInUser = localStorage.getItem('loggedInUser');
            addStatus('6. Login Status',
                loggedInUser ? 'success' : 'loading',
                loggedInUser
                    ? `Logged in as: ${JSON.parse(loggedInUser).name}\n\n${loggedInUser}`
                    : 'Not logged in\n\nYou need to login first via index.html'
            );

            // 7. Check transactions
            try {
                const txSnap = await transactionsRef.orderBy('timestamp', 'desc').limit(5).get();
                addStatus('7. Recent Transactions',
                    txSnap.size > 0 ? 'success' : 'loading',
                    `Total recent: ${txSnap.size}\n\n` +
                    (txSnap.size > 0
                        ? txSnap.docs.map(doc => {
                            const tx = doc.data();
                            const date = tx.timestamp ? tx.timestamp.toDate().toLocaleString('en-GB') : 'N/A';
                            return `${tx.userName}: ${tx.amount > 0 ? '+' : ''}${tx.amount} THB\n  ${tx.description}\n  ${date}`;
                        }).join('\n\n')
                        : 'No transactions yet')
                );
            } catch (error) {
                addStatus('7. Recent Transactions', 'error', error.message);
            }

            // 8. Summary
            addStatus('8. Summary', 'success',
                '‚úÖ Diagnostics complete!\n\n' +
                'If everything looks good, go back to index.html\n\n' +
                'Common issues:\n' +
                '- No authorized users ‚Üí Add via Admin panel\n' +
                '- Not logged in ‚Üí Login via index.html\n' +
                '- Firestore errors ‚Üí Check Firebase Console rules\n' +
                '- Session not found ‚Üí App will create automatically'
            );

            console.log('‚úÖ Diagnostics complete!');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 500);
        });
    </script>
</body>
</html>
